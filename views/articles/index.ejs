<% include ../partials/header %>

<!--User-defined js functions for ejs-->
<%
    function isInMongoArray(mongoArray, id) {
        for (var i=0; i < mongoArray.length; i++) {
            if (mongoArray[i]._id.equals(id)) {
                return true
            }
        }
        return false
    }
%>

<div class="container">
    <div class="row col-lg-12">
        <div class="page-header">
            <h1>Article Feed</h1>
            <h4 style="font-weight: 400;">All of your friends' recommendations</h4>
        </div>
    </div>
    <div class="row">
        <div class="col-md-3">
            <div>
                <h3>Filters</h3>
                <ul class="nav nav-pills nav-stacked">
                    <li id="feed-following" role="presentation"><a href="/articles">Following</a></li>
                    <li id="feed-saved" role="presentation"><a href="/articles/saved">Saved</a></li>
                    <li id="feed-all" role="presentation"><a href="/articles/all">All Users</a></li>
                </ul>
            </div>
        </div>
        <div class="col-md-9">
            <button id="new-post-button" style="margin-bottom: 0.5em" class="btn btn-lg btn-default" >New Post</button>
            <div id="new-post-form" style="display: none;">
                <form action="/articles" method="POST" style="margin-bottom: 40px;">
                    <div class="form-group" style="margin-top: 10px;">
                        <input class="form-control" type="text" name="url" placeholder="Url (include 'http')">
                    </div>
                    <div class="form-group">
                        <input class="form-control" rows="10" type="text" name="desc" placeholder="Your Comments">
                    </div>
                    <div class="form-group">
                        <button class="btn btn-lg btn-primary btn-block">Submit</button>
                    </div>
                </form>
            </div>
            <% if (articles.length == 0) { %>
                   <% if (highlight == "saved") { %>
                        <h4 class="text-center empty-feed">Go save some articles!</h4>
                   <% } else { %>
                        <div class="text-center empty-feed">
                            <h4 onclick="expandForm()">Post an article to populate your feed!</h4>
                            <p>(e.g. https://techcrunch.com/2017/06/04/when-you-look-into-the-news-feed-the-news-feed-looks-into-you/)</p>
                        </div>
                        <!--<a href="/articles/new" class="btn btn-block btn-lg btn-primary empty-feed">Post an article to populate your feed!</a>-->
                   <% } %>
            <% } else { %>
                <div>
                </div>
                <% articles.reverse().forEach((function(article, index) { %>
                    <div class="panel panel-default" style="margin-bottom: 5px;">
                        <div class="panel-body" style="padding-bottom: 0px;">
                            <h3 style="margin-top: 5px;">
                                <a href="/user/<%= article.author.id.toString() %>/">
                                    <%= article.author.username %>
                                </a> 
                                <div>
                                    <small>posted on <span id="moment"><%= article.createdAt %></span></small>
                                    <small>posted on <%= moment(article.createdAt).format() %></small>
                                </div>
                            </h3>
                            
                            <p><%= article.desc %></p>
                            <div class="panel panel-default">
                                <div class="panel-body">
                                    <h4><a href="<%=article.url%>"><%= article.title %></a></h4>
                                    <p><small><%= article.publication %></small></p>
                                    <p><em><%= article.articleDesc %></em>...</p>
                                </div>
                            </div>
                        </div>
                        <div class="panel-footer">                            
                            <a href="/articles/<%= article._id %>" type="button" class="btn btn-default btn-sm pull-left btn-sm-wide">
                                <span class="glyphicon glyphicon-comment" aria-hidden="true"></span> Comments (<%=article.comments.length + 1%>)
                            </a>

                            <% if (isInMongoArray(currentUser.savedArticles, article._id)) { %>
                                <form action="/articles/unsave/<%= article._id%>" method="POST" class="pull-left">
                                    <button class="btn btn-default btn-sm btn-sm-wide pull-left"><span class="glyphicon glyphicon-minus" aria-hidden="true"></span> Unsave</button>
                                </form>
                            <% } else { %>
                                <form action="/articles/save/<%= article._id%>" method="POST" class="pull-left">
                                    <button class="btn btn-default btn-sm btn-sm-wide pull-left"><span class="glyphicon glyphicon-plus" aria-hidden="true"></span> Save</button>
                                </form>
                            <% } %>
                            
                            <button id="share-button" class="btn btn-default btn-sm btn-sm-wide" onclick="showShareLink(<%=index%>)">
                                <span class="glyphicon glyphicon-share" aria-hidden="true"></span> Share
                            </button>
                            <% if (currentUser && article.author.id && article.author.id.equals(currentUser._id)) { %>  
                                <form class="pull-right" action="/articles/<%= article._id %>/?_method=DELETE" method="POST">
                                    <button class="btn btn-default btn-sm btn-sm-wide pull-right"><span class="glyphicon glyphicon-remove-circle" aria-hidden="true"></span> Delete</button>
                                </form>
                                <a href="/articles/<%= article._id %>/edit" type="button" class="btn btn-default btn-sm btn-sm-wide pull-right">
                                    <span class="glyphicon glyphicon-edit" aria-hidden="true"></span> Edit
                                </a>
                            <% } %>
                            <span id="copied-message" style="margin-left: 1.0em; display: none;">Copied!</span>
                            <input id="share-link" style="margin-top: 10px; display: none;" class="form-control" type="text" value="http://localhost:3000/articles/<%=article._id%>"></input>
                        </div>
                    </div>
                <% })); %>
            <% } %>
        </div>
    </div>
</div>

<script src="/js/moment.js"></script>
<script>
    $("[id=moment]").each(function(obj) {
        console.log(obj);
        console.log(this.innerHTML);
        this.innerHTML = moment(this.innerHTML).local().format("MMMM D, h:mm a");
    });

    function expandForm() {
        $("#new-post-form").show("fast", "swing");
    }

    $("#new-post-button").click(expandForm);

    var highlight = "<%=highlight%>";

    if (highlight == "following") {
        $("#feed-following").addClass("active");
    } else if (highlight == "saved") {
        $("#feed-saved").addClass("active");
    } else if (highlight == "all") {
        $("#feed-all").addClass("active");
    }

</script>

<% include ../partials/footer %>